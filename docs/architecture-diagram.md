# Диаграмма архитектуры многопоточности

## Слои архитектуры

```
┌─────────────────────────────────────────────────────────────────┐
│                    Application Layer                           │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ GenerateText    │  │ ProcessRequest  │  │ SearchSimilar   │ │
│  │ UseCase         │  │ UseCase         │  │ UseCase         │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Domain Layer                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ ModelService    │  │ RequestService  │  │ VectorService   │ │
│  │                 │  │                 │  │                 │ │
│  │ • load_model()  │  │ • process()     │  │ • search()      │ │
│  │ • generate()    │  │ • validate()    │  │ • index()       │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                  Infrastructure Layer                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ OptimizedModel  │  │ ThreadingManager│  │ DeviceStrategy  │ │
│  │ Repository      │  │                 │  │                 │ │
│  │                 │  │ • execute_task()│  │ • select_device()│ │
│  │ • load_model()  │  │ • cleanup()     │  │ • is_available()│ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│           │                    │                    │           │
│           ▼                    ▼                    ▼           │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ ModelFactory    │  │ ThreadingStrategy│  │ DeviceStrategy  │ │
│  │                 │  │                 │  │                 │ │
│  │ • create_model()│  │ • AsyncStrategy │  │ • AutoStrategy  │ │
│  │ • validate()    │  │ • ProcessStrategy│  │ • GPUStrategy   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Hardware Layer                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ ThreadPool      │  │ ProcessPool     │  │ GPU/CUDA        │ │
│  │ Executor        │  │ Executor        │  │                 │ │
│  │                 │  │                 │  │ • GPU Memory    │ │
│  │ • I/O Tasks     │  │ • CPU Tasks     │  │ • CUDA Cores    │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## Поток данных

```
Request → API Gateway → Request Processor → AI Model Service
    │           │              │                    │
    ▼           ▼              ▼                    ▼
┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────────────────┐
│ Thread  │ │ Thread  │ │ Thread  │ │ Process Pool            │
│ Pool    │ │ Pool    │ │ Pool    │ │                         │
│ (I/O)   │ │ (I/O)   │ │ (I/O)   │ │ • Model Loading        │
│         │ │         │ │         │ │ • Text Generation       │
│         │ │         │ │         │ │ • Embedding Creation    │
└─────────┘ └─────────┘ └─────────┘ └─────────────────────────┘
    │           │              │                    │
    ▼           ▼              ▼                    ▼
┌─────────────────────────────────────────────────────────────┐
│                    GPU/CUDA                                │
│ • Model Inference                                          │
│ • Tensor Operations                                        │
│ • Memory Management                                        │
└─────────────────────────────────────────────────────────────┘
```

## Стратегии выполнения

### CPU-Bounded задачи
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Text Generation │───▶│ ProcessPool     │───▶│ CPU Cores       │
│                 │    │ Executor        │    │                 │
│ • Model Inference│    │ • max_workers=2 │    │ • Parallel      │
│ • Embeddings    │    │ • CPU-intensive │    │ • Optimized     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### I/O-Bounded задачи
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ HTTP Requests   │───▶│ ThreadPool      │───▶│ Network I/O     │
│                 │    │ Executor        │    │                 │
│ • API Calls     │    │ • max_workers=8 │    │ • Non-blocking  │
│ • File I/O      │    │ • I/O-intensive │    │ • Async         │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Гибридная стратегия
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Task Router     │───▶│ HybridStrategy  │───▶│ Executor        │
│                 │    │                 │    │ Selection       │
│ • Route by type │    │ • Auto-select   │    │                 │
│ • Load balance  │    │ • Optimize perf │    │ • CPU/Thread    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## Фабрики и реестры

```
┌─────────────────────────────────────────────────────────────┐
│                    Factory Registry                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ ModelFactory    │  │ DeviceStrategy  │  │ ThreadingStrategy│ │
│  │ Registry        │  │ Factory         │  │ Factory         │ │
│  │                 │  │                 │  │                 │ │
│  │ • optimized     │  │ • auto          │  │ • async         │ │
│  │ • basic         │  │ • gpu_first     │  │ • process       │ │
│  │ • custom        │  │ • cpu_only      │  │ • hybrid        │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    Concrete Factories                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ OptimizedModel  │  │ AutoDevice      │  │ HybridThreading │ │
│  │ Factory         │  │ Strategy        │  │ Strategy        │ │
│  │                 │  │                 │  │                 │ │
│  │ • create_model()│  │ • select_device()│  │ • execute_task()│ │
│  │ • validate()    │  │ • is_available()│  │ • cleanup()     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## Изоляция низкоуровневых оптимизаций

```
┌─────────────────────────────────────────────────────────────┐
│                    Domain Layer                            │
│ • Чистая бизнес-логика                                    │
│ • Нет зависимостей от конкретных реализаций               │
│ • Абстрактные интерфейсы                                  │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                Infrastructure Layer                         │
│ • Конкретные реализации                                    │
│ • Низкоуровневые оптимизации                              │
│ • Управление ресурсами                                     │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    Hardware Layer                           │
│ • ThreadPoolExecutor                                       │
│ • ProcessPoolExecutor                                      │
│ • CUDA/GPU                                                 │
└─────────────────────────────────────────────────────────────┘
```

## Принципы SOLID

### Single Responsibility Principle
- **DeviceStrategy**: Только выбор устройства
- **ThreadingStrategy**: Только управление потоками
- **ModelFactory**: Только создание моделей

### Open/Closed Principle
- Новые стратегии добавляются без изменения существующего кода
- Новые фабрики регистрируются в реестре

### Liskov Substitution Principle
- Все стратегии взаимозаменяемы
- Все фабрики реализуют общий интерфейс

### Interface Segregation Principle
- Разделение интерфейсов для разных типов задач
- Специализированные стратегии для разных сценариев

### Dependency Inversion Principle
- Domain Layer не зависит от Infrastructure Layer
- Зависимости инвертированы через абстракции
