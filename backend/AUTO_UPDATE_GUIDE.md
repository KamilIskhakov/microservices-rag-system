# Автоматическое обновление базы данных

## Обзор

Система автоматического обновления обеспечивает ежедневное обновление RAG базы данных с сайта Минюста РФ.

## Архитектура

### Компоненты:

1. **DatabaseUpdater** - основной сервис обновления
2. **TaskScheduler** - планировщик задач
3. **API endpoints** - управление обновлениями

### Принципы SOLID:

- **Single Responsibility** - каждый класс отвечает за одну задачу
- **Open/Closed** - легко расширяется новыми парсерами
- **Liskov Substitution** - все парсеры реализуют единый интерфейс
- **Interface Segregation** - четкие интерфейсы для каждой функции
- **Dependency Inversion** - зависимости от абстракций

## API Endpoints

### Обновление базы данных

```bash
# Обычное обновление (проверяет необходимость)
POST /api/v1/update
{
  "force": false
}

# Принудительное обновление
POST /api/v1/update
{
  "force": true
}
```

### Статус обновления

```bash
# Статус последнего обновления
GET /api/v1/update/status

# Статус планировщика
GET /api/v1/scheduler/status

# Запуск задачи немедленно
POST /api/v1/scheduler/run?task_name=database_update
```

## Конфигурация

### Интервал обновления

По умолчанию: 24 часа

Изменить в `app.py`:
```python
scheduler.add_database_update_task(database_updater, interval_hours=24)
```

### Логирование

Все операции логируются в:
- `logs/rag_service.log` - общие логи
- `logs/errors.log` - ошибки

## Мониторинг

### Проверка статуса

```bash
curl http://localhost:8000/api/v1/update/status
```

### Проверка планировщика

```bash
curl http://localhost:8000/api/v1/scheduler/status
```

### Принудительное обновление

```bash
curl -X POST http://localhost:8000/api/v1/update \
  -H "Content-Type: application/json" \
  -d '{"force": true}'
```

## Логика работы

1. **При запуске сервера:**
   - Инициализируется DatabaseUpdater
   - Создается TaskScheduler
   - Добавляется задача обновления БД
   - Планировщик запускается в фоне

2. **Каждые 24 часа:**
   - Проверяется необходимость обновления
   - Если нужно - запускается парсинг
   - Обновляется векторное хранилище
   - Сохраняется время обновления

3. **При ошибках:**
   - Логируется ошибка
   - Увеличивается счетчик ошибок
   - При превышении лимита задача пропускается

## Безопасность

- Rate limiting для API endpoints
- Валидация входных данных
- Логирование всех операций
- Обработка ошибок

## Расширение

### Добавление нового парсера:

1. Создать класс, наследующий `BaseParser`
2. Реализовать все абстрактные методы
3. Добавить в `DatabaseUpdater`

### Добавление новой задачи:

1. Создать функцию-задачу
2. Добавить в `TaskScheduler`
3. Настроить интервал выполнения

## Troubleshooting

### Проблемы:

1. **Парсер не работает:**
   - Проверить доступность сайта Минюста
   - Проверить логи ошибок
   - Проверить сетевые настройки

2. **Планировщик не запускается:**
   - Проверить инициализацию в `app.py`
   - Проверить логи запуска
   - Проверить права доступа

3. **База не обновляется:**
   - Проверить статус через API
   - Проверить логи обновления
   - Запустить принудительное обновление

### Команды для диагностики:

```bash
# Проверить статус
curl http://localhost:8000/api/v1/update/status

# Принудительное обновление
curl -X POST http://localhost:8000/api/v1/update -d '{"force": true}'

# Проверить логи
tail -f logs/rag_service.log
``` 